<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <title>PK – Logowanie</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>

  <body>
    <h1>Logowanie</h1>
    <form id="loginForm">
      <input
        id="email"
        name="email"
        type="email"
        placeholder="email"
        required
        autocomplete="username"
      />
      <input
        id="password"
        name="password"
        type="password"
        placeholder="hasło"
        required
        autocomplete="current-password"
      />
      <button>Zaloguj</button>
    </form>
    <p id="msg"></p>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("loginForm");
        const msg = document.getElementById("msg");

        if (!form) return;

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          msg.textContent = "Logowanie...";

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;

          try {
            const res = await fetch("/api/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password }),
              credentials: "include", // <<< ŻEBY COOKIE SIĘ ZAPISAŁO
            });

            const raw = await res.text();
            console.log("LOGIN RAW RESPONSE:", res.status, raw);

            let data = null;
            try {
              data = JSON.parse(raw);
            } catch (e) {
              // jeśli to nie jest JSON, data zostanie null
            }

            if (!res.ok) {
              const errMsg = (data && data.error) || "Błędne dane logowania";
              msg.textContent = "Logowanie nieudane: " + errMsg;
              alert("Logowanie nieudane: " + errMsg);
              return;
            }

            msg.textContent = "Zalogowano, przekierowanie...";
            // tu cookie już powinno być ustawione
            window.location.href = "/dashboard.html";
          } catch (err) {
            console.error("LOGIN FATAL ERROR:", err);
            msg.textContent = "Logowanie nieudane (błąd połączenia)";
            alert("Błąd połączenia z serwerem: " + (err.message || ""));
          }
        });
      });
    </script>
  </body>
</html>
