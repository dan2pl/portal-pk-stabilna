<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>Szczeg√≥≈Çy sprawy ‚Äì Portal PK</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Je≈õli masz ju≈º globalny CSS (np. styles.css / dashboard.css), pod≈ÇƒÖcz go tutaj -->
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="page">
      <!-- NAG≈Å√ìWEK SPRAWY -->
      <section class="card case-header case-card case-anim case-anim-delay-1">
        <div class="case-header-main">
          <div class="case-title">
            Sprawa <span id="caseId">#12345</span> ‚Äì
            <span id="caseClientName">Imiƒô Nazwisko</span>
          </div>
          <div class="case-subtitle">
            Utworzono: <span id="caseCreatedAt">01.10.2025</span> ¬∑ ProwadzƒÖcy:
            <span id="caseOwner">Jan Kowalski</span>
          </div>
          <input type="hidden" id="caseId" />
          <div class="case-tags">
            <span class="tag tag-primary" id="caseStatus">NOWA</span>
            <span class="tag" id="caseBank">mBank</span>
            <span class="tag" id="caseProductType">Kredyt got√≥wkowy</span>
            <span class="tag tag-success" id="caseSkdTag">SKD aktywna</span>
          </div>
        </div>
        <div class="case-actions">
          <button class="btn btn-outline case-btn" id="btnBack">Powr√≥t</button>
          <button class="btn btn-primary case-btn" id="btnSaveAll">
            Zapisz zmiany
          </button>
          <button
            id="deleteCaseBtn"
            class="btn btn-danger case-btn"
            type="button"
            style="margin-left: 8px"
          >
            Usu≈Ñ sprawƒô
          </button>
        </div>
      </section>

      <section class="case-layout">
        <!-- LEWY SIDEBAR -->
        <aside class="case-sidebar">
          <div class="card case-card case-anim case-anim-delay-1">
            <div class="case-sidebar-section-title">Podsumowanie finansowe</div>
            <div class="case-sidebar-row">
              <span class="case-sidebar-label">Kwota kredytu</span>
              <span class="case-sidebar-value" id="summaryAmount"
                >50 000 z≈Ç</span
              >
            </div>
            <div class="case-sidebar-row">
              <span class="case-sidebar-label">Ca≈Çkowity koszt</span>
              <span class="case-sidebar-value" id="summaryTotalCost"
                >20 000 z≈Ç</span
              >
            </div>
            <div class="case-sidebar-row">
              <span class="case-sidebar-label">Potencja≈Ç SKD</span>
              <span class="case-sidebar-value" id="summarySkdPotential"
                >18 500 z≈Ç</span
              >
            </div>
            <div class="case-sidebar-row">
              <span class="case-sidebar-label">WPS (prognoza)</span>
              <span class="case-sidebar-value" id="summaryWps">
                12 300 z≈Ç
              </span>
            </div>
          </div>

          <div class="card case-details case-card case-anim case-anim-delay-2">
            <div class="case-sidebar-section-title">Status sprawy</div>
            <div class="case-sidebar-row">
              <span class="case-sidebar-label">Etap</span>
              <span class="case-sidebar-value" id="summaryStage">
                Analiza
              </span>
            </div>
            <div class="case-sidebar-row">
              <span class="case-sidebar-label">Status SKD</span>
              <span class="case-sidebar-value" id="summarySkdStatus">
                W przygotowaniu
              </span>
            </div>
            <div class="case-sidebar-row">
              <span class="case-sidebar-label">Ostatnia zmiana</span>
              <span class="case-sidebar-value" id="summaryLastUpdate">
                21.11.2025
              </span>
            </div>
            <div
              class="case-sidebar-section-title"
              style="margin-top: 10px; margin-bottom: 4px"
            >
              Postƒôp sprawy
            </div>
            <div class="case-progress-bar">
              <div
                id="caseProgressFill"
                class="case-progress-fill"
                aria-label="Postƒôp sprawy"
              ></div>
            </div>
          </div>
        </aside>

        <!-- PRAWA STRONA: TABS + PANELS -->
        <main class="card case-card case-anim case-anim-delay-2">
          <!-- TABS -->
          <div class="case-tabs" id="caseTabs">
            <button class="case-tab active" data-tab="client">
              Dane klienta
            </button>
            <button class="case-tab" data-tab="credit">Dane kredytu</button>
            <button class="case-tab" data-tab="skd">SKD</button>
            <button class="case-tab" data-tab="docs">Dokumenty</button>
            <button class="case-tab" data-tab="notes">Notatki</button>
            <button class="case-tab" data-tab="history">Historia zmian</button>
          </div>

          <!-- PANELS -->
          <div class="tab-panels">
            <!-- PANEL: DANE KLIENTA -->
            <section
              class="tab-panel active case-anim case-anim-delay-1"
              data-tab-panel="client"
              id="panelClient"
            >
              <div class="accordion">
                <div class="accordion-item open">
                  <div class="accordion-header">
                    <div class="accordion-title">Dane podstawowe</div>
                    <div class="accordion-toggle">‚ñ∂</div>
                  </div>
                  <div class="accordion-body">
                    <div class="field-row">
                      <div class="field">
                        <label for="clientName">Imiƒô i nazwisko</label>
                        <input type="text" id="clientName" autocomplete="off" />
                      </div>
                      <div class="field">
                        <label for="clientPesel">PESEL</label>
                        <input
                          type="text"
                          id="clientPesel"
                          autocomplete="off"
                        />
                      </div>
                      <div class="field">
                        <label for="clientPhone">Telefon</label>
                        <input
                          type="text"
                          id="clientPhone"
                          autocomplete="off"
                        />
                      </div>
                      <div class="field">
                        <label for="clientEmail">E-mail</label>
                        <input
                          type="email"
                          id="clientEmail"
                          autocomplete="off"
                        />
                      </div>
                    </div>

                    <div class="field-row">
                      <div class="field">
                        <label for="clientCity">Miasto</label>
                        <input type="text" id="clientCity" autocomplete="off" />
                      </div>
                      <div class="field">
                        <label for="clientPostcode">Kod pocztowy</label>
                        <input
                          type="text"
                          id="clientPostcode"
                          autocomplete="off"
                        />
                      </div>
                      <div class="field">
                        <label for="clientStreet">Ulica i nr</label>
                        <input
                          type="text"
                          id="clientStreet"
                          autocomplete="off"
                        />
                      </div>
                    </div>
                    <div class="field-row">
                      <div class="field">
                        <label for="contractIban"
                          >Numer konta klienta (do umowy)</label
                        >
                        <input
                          type="text"
                          id="contractIban"
                          autocomplete="off"
                        />
                      </div>
                    </div>

                    <div class="section-actions">
                      <button
                        class="btn btn-outline case-btn"
                        id="btnClientCancel"
                      >
                        Anuluj
                      </button>
                      <button
                        class="btn btn-primary case-btn"
                        id="btnClientSave"
                      >
                        Zapisz dane klienta
                      </button>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <div class="accordion-header">
                    <div class="accordion-title">Dodatkowe informacje</div>
                    <div class="accordion-toggle">‚ñ∂</div>
                  </div>
                  <div class="accordion-body">
                    <div class="field">
                      <label for="clientNotes">Uwagi o kliencie</label>
                      <textarea id="clientNotes"></textarea>
                    </div>
                    <div class="section-actions">
                      <button class="btn btn-outline" id="btnClientNotesCancel">
                        Anuluj
                      </button>
                      <button class="btn btn-primary" id="btnClientNotesSave">
                        Zapisz uwagi
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- PANEL: DANE KREDYTU -->
            <section
              class="tab-panel case-anim case-anim-delay-2"
              data-tab-panel="credit"
              id="panelCredit"
            >
              <div class="accordion">
                <div class="accordion-item open">
                  <div class="accordion-header">
                    <div class="accordion-title">Parametry kredytu</div>
                    <div class="accordion-toggle">‚ñ∂</div>
                  </div>
                  <div class="accordion-body">
                    <div class="field-row">
                      <div class="field">
                        <label for="creditBank">Bank</label>
                        <input type="text" id="creditBank" />
                      </div>
                      <div class="field">
                        <label for="creditProduct">Produkt</label>
                        <input type="text" id="creditProduct" />
                      </div>
                      <div class="field">
                        <label for="creditAmount">Kwota kredytu</label>
                        <input type="number" id="creditAmount" />
                      </div>
                      <div class="field">
                        <label for="creditTotalCost">Ca≈Çkowity koszt</label>
                        <input type="number" id="creditTotalCost" />
                      </div>
                    </div>

                    <div class="field-row">
                      <div class="field">
                        <label for="creditStartDate">Data uruchomienia</label>
                        <input type="date" id="creditStartDate" />
                      </div>
                      <div class="field">
                        <label for="creditEndDate">Data zako≈Ñczenia</label>
                        <input type="date" id="creditEndDate" />
                      </div>
                      <div class="field">
                        <label for="creditInstallment"> Miesiƒôczna rata </label>
                        <input type="number" id="creditInstallment" />
                      </div>
                    </div>

                    <div class="section-actions">
                      <button class="btn btn-outline" id="btnCreditCancel">
                        Anuluj
                      </button>
                      <button class="btn btn-primary" id="btnCreditSave">
                        Zapisz dane kredytu
                      </button>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <div class="accordion-header">
                    <div class="accordion-title">Uwagi do umowy</div>
                    <div class="accordion-toggle">‚ñ∂</div>
                  </div>
                  <div class="accordion-body">
                    <div class="field">
                      <label for="creditNotes">Uwagi</label>
                      <textarea id="creditNotes"></textarea>
                    </div>
                    <div class="section-actions">
                      <button class="btn btn-outline" id="btnCreditNotesCancel">
                        Anuluj
                      </button>
                      <button class="btn btn-primary" id="btnCreditNotesSave">
                        Zapisz uwagi
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- PANEL: SKD -->
            <section
              class="tab-panel case-anim case-anim-delay-3"
              data-tab-panel="skd"
              id="panelSkd"
            >
              <div class="accordion">
                <div class="accordion-item open">
                  <div class="accordion-header">
                    <div class="accordion-title">
                      <div class="field-row">
                        <!-- Status SKD ‚Äì na razie tylko informacyjny (podsumowanie) -->
                        <div class="field">
                          <label>Status SKD</label>
                          <div id="skdStatusLabel">
                            <!-- Tu JS wstawi tekst typu "W procesie" / "SKD uznane" -->
                          </div>
                        </div>

                        <!-- G≈Å√ìWNY etap sprawy ‚Äì spiƒôty z status_code -->
                        <div class="field">
                          <label for="caseStage">Etap sprawy</label>
                          <select id="caseStage">
                            <option value="NEW">Nowa</option>
                            <option value="ANALYSIS">W analizie</option>
                            <option value="ANALYSIS_DOCS_NEEDED">
                              Braki dokument√≥w do analizy
                            </option>
                            <option value="ANALYSIS_POSITIVE">
                              Analiza pozytywna
                            </option>
                            <option value="ANALYSIS_NEGATIVE">
                              Odrzucona w analizie
                            </option>
                            <option value="CONTRACT_PREP">
                              Przygotowanie umowy
                            </option>
                            <option value="CONTRACT_DOCS_NEEDED">
                              Oczekiwanie na dokumenty do wykupu
                            </option>
                            <option value="CONTRACT_AT_AGENT">
                              Umowa u agenta
                            </option>
                            <option value="CONTRACT_SIGNED">
                              Umowa zawarta
                            </option>
                            <option value="IN_PROGRESS">W toku</option>
                            <option value="CLOSED_SUCCESS">
                              Zako≈Ñczona ‚Äì Sukces
                            </option>
                            <option value="CLOSED_FAIL">
                              Zako≈Ñczona ‚Äì Przegrana
                            </option>
                            <option value="CLIENT_RESIGNED">
                              Rezygnacja klienta
                            </option>
                          </select>
                        </div>
                      </div>

                      <div class="field">
                        <label for="skdDate">Data wys≈Çania SKD</label>
                        <input type="date" id="skdDate" />
                      </div>
                      <div class="field">
                        <label for="skdPotential">Potencja≈Ç SKD (szac.)</label>
                        <input type="number" id="skdPotential" />
                      </div>
                    </div>

                    <div class="field-row">
                      <div class="field">
                        <label for="skdWpsForecast">Prognoza WPS</label>
                        <input type="number" id="skdWpsForecast" />
                      </div>
                      <div class="field">
                        <label for="skdOfferVariant">Wariant oferty</label>
                        <select id="skdOfferVariant">
                          <option value="prosty">Prosty</option>
                          <option value="standard">Standard</option>
                          <option value="premia">
                            Premia / wyp≈Çata z g√≥ry
                          </option>
                        </select>
                      </div>
                    </div>

                    <div class="section-actions">
                      <button class="btn btn-outline" id="btnSkdCancel">
                        Anuluj
                      </button>
                      <button class="btn btn-primary" id="btnSkdSave">
                        Zapisz dane SKD
                      </button>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <div class="accordion-header">
                    <div class="accordion-title">Oferta dla klienta</div>
                    <div class="accordion-toggle">‚ñ∂</div>
                  </div>
                  <div class="accordion-body">
                    <div class="field-row">
                      <div class="field">
                        <label for="skdOfferText"
                          >Tre≈õƒá oferty / ustalenia</label
                        >
                        <textarea id="skdOfferText"></textarea>
                      </div>
                    </div>
                    <div class="section-actions">
                      <button class="btn btn-outline" id="btnSkdOfferCancel">
                        Anuluj
                      </button>
                      <button class="btn btn-primary" id="btnSkdOfferSave">
                        Zapisz ofertƒô
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- PANEL: DOKUMENTY -->
            <section
              class="tab-panel case-anim case-anim-delay-2"
              data-tab-panel="docs"
              id="panelDocs"
            >
              <div class="accordion">
                <div class="accordion-item open">
                  <div class="accordion-header">
                    <div class="accordion-title">Lista dokument√≥w</div>
                    <div class="accordion-toggle">‚ñ∂</div>
                  </div>
                  <div class="accordion-body">
                    <!-- === DOKUMENTY ‚Äì PREMIUM (dopasowane do accordion) === -->
                    <div id="documentsSection">
                      <!-- Drag & Drop -->
                      <div class="file-drop-area" id="caseFileDropArea">
                        <div class="upload-hint">
                          üìÑ <strong>Obs≈Çugiwane formaty:</strong> PDF, JPG,
                          PNG, DOC, XLS, TXT <br />üì∏
                          <strong>Uwaga:</strong> Zdjƒôcia z iPhone w formacie
                          HEIC/HEIF nie sƒÖ obs≈Çugiwane ‚Äî w razie potrzeby zmie≈Ñ
                          format aparatu na JPG lub u≈ºyj opcji ‚ÄûZapisz jako
                          PDF‚Äù.
                        </div>
                        <div class="file-drop-message">
                          üìé Upu≈õƒá tutaj pliki lub
                          <span class="file-browse">kliknij</span>, aby dodaƒá
                          dokumenty
                        </div>
                        <input type="file" id="caseAddFiles" multiple hidden />
                        <p class="upload-hint">
                          Mo≈ºesz dodaƒá maks. 10 plik√≥w, ka≈ºdy do 20 MB.<br />
                          Dozwolone formaty: PDF, JPG, PNG, DOC, XLS, TXT.<br />
                          W razie du≈ºych plik√≥w u≈ºyj kompresji PDF:
                          <a
                            href="https://www.ilovepdf.com/compress_pdf"
                            target="_blank"
                            >iLovePDF</a
                          >
                        </p>
                      </div>

                      <!-- Lista dokument√≥w -->
                      <div id="caseFileList" class="file-list-wrapper">
                        <div class="file-list-empty">
                          Brak plik√≥w w tej sprawie
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- PANEL: NOTATKI -->
            <section
              class="tab-panel case-anim case-anim-delay-3"
              data-tab-panel="notes"
              id="panelNotes"
            >
              <div class="accordion">
                <div class="accordion-item open">
                  <div class="accordion-header">
                    <div class="accordion-title">Notatki wewnƒôtrzne</div>
                    <div class="accordion-toggle">‚ñ∂</div>
                  </div>
                  <div class="accordion-body">
                    <div class="field">
                      <label for="caseNotes">Notatki</label>
                      <textarea id="caseNotes"></textarea>
                    </div>
                    <div class="section-actions">
                      <button class="btn btn-outline" id="btnCaseNotesCancel">
                        Anuluj
                      </button>
                      <button class="btn btn-primary" id="btnCaseNotesSave">
                        Zapisz notatki
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <!-- PANEL: HISTORIA ZMIAN -->
            <section
              class="tab-panel case-anim case-anim-delay-4"
              data-tab-panel="history"
              id="panelHistory"
            >
              <div class="accordion">
                <div class="accordion-item open">
                  <div class="accordion-header">
                    <div class="accordion-title">O≈õ czasu zmian</div>
                    <div class="accordion-toggle">‚ñ∂</div>
                  </div>
                  <div class="accordion-body">
                    <!-- Tu w Etapie 14C pod≈ÇƒÖczymy historiƒô z bazy -->
                    <div class="case-history-list" id="caseHistoryList">
                      <!-- Na razie mock ‚Äì p√≥≈∫niej podmienimy na dane z API -->
                      <div
                        class="case-history-item case-anim case-anim-delay-1"
                      >
                        <div class="case-history-dot"></div>
                        <div class="case-history-content">
                          <div class="case-history-title">Sprawa utworzona</div>
                          <div class="case-history-meta">
                            12.10.2025 ¬∑ system
                          </div>
                        </div>
                      </div>

                      <div
                        class="case-history-item case-anim case-anim-delay-2"
                      >
                        <div class="case-history-dot"></div>
                        <div class="case-history-content">
                          <div class="case-history-title">
                            Dodano dane kredytu
                          </div>
                          <div class="case-history-meta">
                            14.10.2025 ¬∑ Jan Kowalski
                          </div>
                        </div>
                      </div>

                      <div
                        class="case-history-item case-anim case-anim-delay-3"
                      >
                        <div class="case-history-dot"></div>
                        <div class="case-history-content">
                          <div class="case-history-title">
                            Przygotowanie SKD
                          </div>
                          <div class="case-history-meta">
                            21.10.2025 ¬∑ Jan Kowalski
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </main>
      </section>
    </div>

    <script>
      // === KONFIG ===
      const API_BASE = "/api";

      // === GLOBALNE ETYKIETY STATUS√ìW (jedyna prawda) ===
      const CASE_STATUS_LABELS = {
        NEW: "Nowa",
        ANALYSIS: "W analizie",
        ANALYSIS_DOCS_NEEDED: "Braki dokument√≥w do analizy",
        ANALYSIS_POSITIVE: "Analiza pozytywna",
        ANALYSIS_NEGATIVE: "Analiza negatywna",
        CONTRACT_PREP: "Przygotowanie umowy",
        CONTRACT_DOCS_NEEDED: "Oczekiwanie na dokumenty",
        CONTRACT_AT_AGENT: "Umowa u agenta",
        CONTRACT_SIGNED: "Umowa zawarta",
        IN_PROGRESS: "W toku",
        CLOSED_SUCCESS: "Zako≈Ñczona ‚Äì Sukces",
        CLOSED_FAIL: "Zako≈Ñczona ‚Äì Przegrana",
        CLIENT_RESIGNED: "Rezygnacja klienta",
      };
      // === LOGIKA TABS ===
      const tabButtons = document.querySelectorAll(".case-tab");
      const tabPanels = document.querySelectorAll(".tab-panel");

      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;

          tabButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          tabPanels.forEach((panel) => {
            const panelTab = panel.dataset.tabPanel;
            panel.classList.toggle("active", panelTab === tab);
          });
        });
      });

      // === LOGIKA ACCORDION ===
      document.querySelectorAll(".accordion-header").forEach((header) => {
        header.addEventListener("click", () => {
          const item = header.closest(".accordion-item");
          const isOpen = item.classList.contains("open");
          item.classList.toggle("open", !isOpen);
        });
      });

      // === POMOCNICZE ===

      function getCaseIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id");
      }

      function normalizeDateToInput(value) {
        if (!value) return "";
        const d = new Date(value);
        if (isNaN(d.getTime())) return "";
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${yyyy}-${mm}-${dd}`;
      }

      function formatCurrency(value) {
        if (value == null || value === "") return "‚Äî";
        const num = Number(value);
        if (isNaN(num)) return String(value);
        return (
          num.toLocaleString("pl-PL", {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }) + " z≈Ç"
        );
      }

      function $(id) {
        return document.getElementById(id);
      }

      // === PROGRES ETAPU SPRAWY (NOWY SYSTEM) ===

      function stageToProgress(statusCode) {
        switch (statusCode) {
          case "NEW":
            return 5;

          case "ANALYSIS":
            return 20;

          case "ANALYSIS_DOCS_NEEDED":
            return 25;

          case "ANALYSIS_POSITIVE":
            return 35;

          case "ANALYSIS_NEGATIVE":
            return 0;

          case "CONTRACT_PREP":
            return 50;

          case "CONTRACT_DOCS_NEEDED":
            return 55;

          case "CONTRACT_AT_AGENT":
            return 65;

          case "CONTRACT_SIGNED":
            return 75;

          case "IN_PROGRESS":
            return 85;

          case "CLOSED_SUCCESS":
            return 100;

          case "CLOSED_FAIL":
          case "CLIENT_RESIGNED":
            return 0;

          default:
            return 0;
        }
      }

      function updateCaseProgress(statusCode) {
        const fill = document.getElementById("caseProgressFill");
        if (!fill) return;
        const percent = stageToProgress(statusCode);
        fill.style.width = percent + "%";
      }

      // üîπ JEDNO globalne caseStageSelect + caseIdInput
      const caseStageSelect = document.getElementById("caseStage");
      const caseIdInput = document.getElementById("caseId");

      async function saveCaseStatus() {
        if (!caseStageSelect) return;

        const caseId =
          Number(caseIdInput?.value) ||
          Number(new URLSearchParams(window.location.search).get("id"));

        const status = caseStageSelect.value;

        if (!caseId || !status) {
          console.warn("Brak caseId lub statusu przy zapisie etapu", {
            caseId,
            status,
          });
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/cases/update-status`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ caseId, status }),
          });

          const data = await res.json();
          if (!data.ok) {
            console.error("B≈ÇƒÖd przy zmianie statusu", data);
            alert("Nie uda≈Ço siƒô zapisaƒá etapu sprawy.");
            return;
          }

          console.log("‚úÖ Status sprawy zapisany:", data.case);

          updateCaseProgress(status);
        } catch (err) {
          console.error("B≈ÇƒÖd requestu przy zmianie statusu:", err);
          alert("WystƒÖpi≈Ç b≈ÇƒÖd przy zapisie etapu sprawy.");
        }
      }

      if (caseStageSelect) {
        caseStageSelect.addEventListener("change", saveCaseStatus);
      }

      // === WYPE≈ÅNIANIE DANYCH Z API ===

      function fillCaseHeader(data) {
        const caseIdHidden = document.getElementById("caseId");
        if (caseIdHidden) {
          caseIdHidden.value = data.id ?? data.caseId ?? "";
        }

        const caseId = data.id ?? data.caseId ?? "";
        const clientName =
          data.client ??
          data.clientName ??
          data.client_name ??
          data.client_full_name ??
          "‚Äî";

        const createdAt =
          data.contract_date ?? data.createdAt ?? data.created_at ?? null;

        const owner =
          data.ownerName ?? data.owner_name ?? data.caseOwner ?? "‚Äî";

        const status =
          data.status ?? data.caseStatus ?? data.case_status ?? "‚Äî";

        const bank =
          data.bank ??
          data.bankName ??
          data.bank_name ??
          data.creditBank ??
          "‚Äî";

        const product =
          data.productType ?? data.product_type ?? "Kredyt got√≥wkowy";

        const skdActive =
          data.skdActive ?? data.skd_active ?? data.hasSkd ?? false;

        $("caseId").textContent = caseId ? `#${caseId}` : "‚Äî";
        $("caseClientName").textContent = clientName;
        $("caseCreatedAt").textContent = createdAt
          ? new Date(createdAt).toLocaleDateString("pl-PL")
          : "‚Äî";
        $("caseOwner").textContent = owner;

        const statusEl = $("caseStatus");
        statusEl.textContent = status || "‚Äî";

        $("caseBank").textContent = bank;
        $("caseProductType").textContent = product;

        const skdTag = $("caseSkdTag");
        if (skdActive) {
          skdTag.textContent = "SKD aktywna";
          skdTag.classList.add("tag-success");
        } else {
          skdTag.textContent = "SKD brak";
          skdTag.classList.remove("tag-success");
        }
      }

      function fillSidebar(data) {
        const creditAmount =
          data.loan_amount ??
          data.creditAmount ??
          data.credit_amount ??
          data.loanAmount;

        const totalCost =
          data.total_cost ??
          data.creditTotalCost ??
          data.credit_total_cost ??
          null;

        const skdPotential = data.skd_potential ?? data.skdPotential ?? null;

        const wps = data.wps_forecast ?? data.wps_final ?? data.wps ?? null;

        const stage =
          data.stage ??
          data.caseStage ??
          data.status_stage ??
          data.status ??
          "‚Äî";

        const skdStatus = data.skd_status ?? data.skdStatus ?? "‚Äî";

        const lastUpdate = data.updated_at ?? data.updatedAt ?? null;

        $("summaryAmount").textContent = formatCurrency(creditAmount);
        $("summaryTotalCost").textContent = formatCurrency(totalCost);
        $("summarySkdPotential").textContent = formatCurrency(skdPotential);
        $("summaryWps").textContent = formatCurrency(wps);

        $("summaryStage").textContent = stage;
        $("summarySkdStatus").textContent = skdStatus;
        $("summaryLastUpdate").textContent = lastUpdate
          ? new Date(lastUpdate).toLocaleDateString("pl-PL")
          : "‚Äî";
      }

      function splitAddress(address) {
        if (!address) {
          return { street: "", city: "", postcode: "" };
        }

        const [left, right] = address.split(",").map((s) => s.trim());

        let street = right || "";
        let city = "";
        let postcode = "";

        if (left) {
          const parts = left.split(/\s+/);
          if (parts.length > 1 && /^\d{2}-\d{3}$/.test(parts[0])) {
            postcode = parts[0];
            city = parts.slice(1).join(" ");
          } else {
            city = left;
          }
        }

        if (!right && !street) {
          street = address;
        }

        return { street, city, postcode };
      }
      // === IBAN ‚Äì autoformatowanie w polu "Numer konta klienta" ===
      function attachIbanFormatter() {
        const input = $("contractIban");
        if (!input) return;

        function formatValue() {
          const raw = input.value || "";
          const clean = raw.replace(/\s+/g, "").toUpperCase();

          // je≈õli kr√≥cej ni≈º 3 znaki ‚Äì nie kombinujemy
          if (clean.length <= 2) {
            input.value = clean;
            return;
          }

          const first2 = clean.slice(0, 2); // np. "PL" / "97"
          const rest = clean.slice(2); // reszta po tych 2 znakach

          // resztƒô grupujemy po 4 znaki
          const restGrouped = rest.replace(/(.{4})/g, "$1 ").trim();

          // sk≈Çadamy wynik: "PL" + spacja + grupy po 4
          input.value = restGrouped ? `${first2} ${restGrouped}` : first2;
        }

        input.addEventListener("input", formatValue);
        input.addEventListener("blur", formatValue);
      }

      function attachIbanValidator() {
        const input = $("contractIban");
        if (!input) return;

        // Tworzymy ma≈Çy element z b≈Çƒôdem (na ≈ºywo, bez HTML-a)
        const errorBox = document.createElement("div");
        errorBox.style.color = "#d9534f";
        errorBox.style.fontSize = "12px";
        errorBox.style.marginTop = "4px";
        errorBox.style.display = "none";
        errorBox.textContent = "Niepoprawny numer IBAN";
        input.insertAdjacentElement("afterend", errorBox);

        input.addEventListener("input", () => {
          const raw = input.value.replace(/\s+/g, "");
          let isValid = true;

          // Dopuszczamy te≈º czyste wpisywanie PL‚Ä¶ lub same cyfry
          const hasPL = /^[A-Z]{2}\d+$/.test(raw);

          // Zasada walidacji:
          // 26 cyfr (PL pomijamy, bo formatowanie je doda)
          if (!/^\d{0,26}$/.test(raw.replace(/[A-Z]/gi, ""))) {
            isValid = false;
          }

          if (raw.length > 0 && raw.length < 26) {
            // Za kr√≥tki ‚Äî ale nie traktujemy tego jako error, p√≥ki u≈ºytkownik pisze
            isValid = true;
            errorBox.style.display = "none";
            input.style.borderColor = "";
            return;
          }

          // Je≈õli u≈ºytkownik wpisze PL‚Ä¶ ‚Äî pozwalamy, ale sprawdzamy, czy reszta to cyfry
          if (raw.startsWith("PL") && raw.length !== 28) {
            isValid = false;
          }

          if (!isValid) {
            input.style.borderColor = "#d9534f";
            errorBox.style.display = "block";
          } else {
            input.style.borderColor = "";
            errorBox.style.display = "none";
          }
        });
      }
      function fillClientSection(data) {
        // --- Dane klienta ---
        $("clientName").value =
          data.client ??
          data.clientName ??
          data.client_name ??
          data.client_full_name ??
          "";

        $("clientPesel").value =
          data.pesel ?? data.clientPesel ?? data.client_pesel ?? "";

        $("clientPhone").value =
          data.phone ?? data.clientPhone ?? data.client_phone ?? "";

        $("clientEmail").value =
          data.email ?? data.clientEmail ?? data.client_email ?? "";

        const addr = data.address ?? "";
        const { street, city, postcode } = splitAddress(addr);

        $("clientStreet").value = street;
        $("clientCity").value = city;
        $("clientPostcode").value = postcode;

        $("clientNotes").value = data.clientNotes ?? data.client_notes ?? "";

        // --- IBAN (je≈õli backend go zwraca) ---
        const ibanInput = $("contractIban");
        if (ibanInput) {
          const ibanFromData =
            data.iban ?? data.contractIban ?? data.clientIban ?? "";
          ibanInput.value = ibanFromData || "";
        }

        // --- ETAP SPRAWY / STATUS_CODE ---

        // 1. Najpierw pr√≥bujemy status_code z backendu (docelowe pole)
        let statusCode = data.status_code;

        // 2. Je≈õli nie ma status_code ‚Äì pr√≥bujemy odczytaƒá go ze starego pola "status"
        if (!statusCode) {
          const raw = data.status;

          if (raw) {
            const upper = String(raw).toUpperCase();

            // pe≈Çna lista naszych kod√≥w statusu
            const known = [
              "NEW",
              "ANALYSIS",
              "ANALYSIS_DOCS_NEEDED",
              "ANALYSIS_POSITIVE",
              "ANALYSIS_NEGATIVE",
              "CONTRACT_PREP",
              "CONTRACT_DOCS_NEEDED",
              "CONTRACT_AT_AGENT",
              "CONTRACT_SIGNED",
              "IN_PROGRESS",
              "CLOSED_SUCCESS",
              "CLOSED_FAIL",
              "CLIENT_RESIGNED",
            ];

            if (known.includes(upper)) {
              // üü¢ w bazie ju≈º siedzi nowy kod ‚Üí u≈ºywamy go 1:1
              statusCode = upper;
            } else {
              // üîô stary schemat z polskimi nazwami typu "analiza", "przygotowanie" itd.
              const legacy = String(raw).toLowerCase();
              switch (legacy) {
                case "nowa":
                  statusCode = "NEW";
                  break;
                case "analiza":
                  statusCode = "ANALYSIS";
                  break;
                case "przygotowanie":
                  statusCode = "CONTRACT_PREP";
                  break;
                case "wyslane":
                  statusCode = "IN_PROGRESS";
                  break;
                case "uznane":
                  statusCode = "CLOSED_SUCCESS";
                  break;
                case "odrzucone":
                  statusCode = "CLOSED_FAIL";
                  break;
                default:
                  statusCode = "NEW";
              }
            }
          } else {
            statusCode = "NEW";
          }
        }

        // 3. Ustawiamy dropdown "Etap sprawy" i pasek postƒôpu
        if (caseStageSelect && statusCode) {
          caseStageSelect.value = statusCode;
          updateCaseProgress(statusCode);
        }
      }

      function fillCreditSection(data) {
        $("creditBank").value =
          data.bank ?? data.creditBank ?? data.bankName ?? data.bank_name ?? "";

        $("creditProduct").value = data.productType ?? data.product_type ?? "";

        $("creditAmount").value =
          data.loan_amount ?? data.creditAmount ?? data.credit_amount ?? "";

        $("creditTotalCost").value =
          data.total_cost ??
          data.creditTotalCost ??
          data.credit_total_cost ??
          "";

        $("creditStartDate").value = normalizeDateToInput(
          data.contract_date ?? data.creditStartDate ?? data.credit_start_date
        );

        $("creditEndDate").value = normalizeDateToInput(
          data.creditEndDate ?? data.credit_end_date
        );

        $("creditInstallment").value =
          data.creditInstallment ?? data.credit_installment ?? "";

        $("creditNotes").value = data.creditNotes ?? data.credit_notes ?? "";
      }

      function fillSkdSection(data) {
        console.log("[fillSkdSection] data =", data);

        const skdDate = data.skdDate ?? data.skd_date ?? data.skdSentDate;
        const skdPotential = data.skdPotential ?? data.skd_potential ?? "";
        const wps =
          data.skdWpsForecast ??
          data.skd_wps_forecast ??
          data.wpsForecast ??
          data.wps_forecast ??
          "";
        const variant =
          data.skdOfferVariant ?? data.skd_offer_variant ?? "prosty";
        const offerText = data.skdOfferText ?? data.skd_offer_text ?? "";

        const skdDateInput = $("skdDate");
        if (skdDateInput) {
          skdDateInput.value = normalizeDateToInput(skdDate);
        }

        const skdPotentialInput = $("skdPotential");
        if (skdPotentialInput) {
          skdPotentialInput.value = skdPotential;
        }

        const wpsInput = $("skdWpsForecast");
        if (wpsInput) {
          wpsInput.value = wps;
        }

        const variantSelect = $("skdOfferVariant");
        if (variantSelect) {
          variantSelect.value = variant;
        }

        const offerTextArea = $("skdOfferText");
        if (offerTextArea) {
          offerTextArea.value = offerText;
        }

        // NIC nie ruszamy w etapie / pasku
      }
      function fillNotesSection(data) {
        $("caseNotes").value =
          data.notes ?? data.caseNotes ?? data.case_notes ?? "";
      }

      // === FETCH DANYCH ===
      async function fetchCaseDetails(caseId) {
        const res = await fetch(
          `${API_BASE}/cases/${encodeURIComponent(caseId)}`
        );
        if (res.status === 403) {
          alert("‚õî Nie masz dostƒôpu do tej sprawy");
          window.location.href = "dashboard.html";
          return;
        }

        if (!res.ok) {
          throw new Error(`B≈ÇƒÖd pobierania danych sprawy: ${res.status}`);
        }
        return await res.json();
      }

      // === ZAPISY DO BACKENDU ===
      async function saveSection(caseId, section, payload) {
        let url = null;
        let method = "PATCH";

        switch (section) {
          case "client":
          case "credit":
          case "skd":
          case "notes":
            url = `${API_BASE}/cases/${caseId}`;
            break;
          case "skd-offer":
            url = `${API_BASE}/cases/${caseId}/skd-offer`;
            method = "PUT";
            break;
          default:
            throw new Error(`Nieznana sekcja zapisu: ${section}`);
        }

        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(`B≈ÇƒÖd zapisu ${section}: ${res.status} ${text}`);
        }

        return res.json().catch(() => ({}));
      }

      function showSaveToast(message) {
        const existing = document.querySelector(".case-toast");
        if (existing) {
          existing.remove();
        }

        const toast = document.createElement("div");
        toast.className = "case-toast";
        toast.textContent = message || "Zapisano ‚úÖ";

        document.body.appendChild(toast);

        requestAnimationFrame(() => {
          toast.classList.add("case-toast--visible");
        });

        setTimeout(() => {
          toast.classList.remove("case-toast--visible");
          setTimeout(() => toast.remove(), 300);
        }, 1800);
      }

      function handleSectionSaved(btn, message) {
        showSaveToast(message || "Zapisano zmiany ‚úÖ");
      }

      function attachFieldChangeMicroFX() {
        const inputs = document.querySelectorAll(
          "#panelClient input, #panelClient select, #panelClient textarea," +
            " #panelCredit input, #panelCredit select, #panelCredit textarea," +
            " #panelSkd input, #panelSkd select, #panelSkd textarea," +
            " #panelNotes textarea"
        );

        inputs.forEach((el) => {
          let lastValue = el.value;
          el.addEventListener("change", () => {
            if (el.value === lastValue) return;
            lastValue = el.value;

            el.classList.remove("case-input-changed");
            void el.offsetWidth;
            el.classList.add("case-input-changed");

            setTimeout(() => {
              el.classList.remove("case-input-changed");
            }, 500);
          });
        });
      }

      function attachSaveHandlers(caseId) {
        // === KLIENT ‚Äì dane podstawowe ===
        const btnClient = $("btnClientSave");
        btnClient?.addEventListener("click", async () => {
          const ibanRaw = $("contractIban").value.trim();
          const payload = {
            client: $("clientName").value.trim(),
            pesel: $("clientPesel").value.trim(),
            phone: $("clientPhone").value.trim(),
            email: $("clientEmail").value.trim(),
            address: `${$("clientPostcode").value.trim()} ${$(
              "clientCity"
            ).value.trim()}, ${$("clientStreet").value.trim()}`,
            iban: ibanRaw.replace(/\s+/g, "") || null, // zapisujemy BEZ spacji
          };

          try {
            await saveSection(caseId, "client", payload);
            handleSectionSaved(btnClient, "Dane klienta zapisane");
          } catch (e) {
            console.error(e);
            showSaveToast("B≈ÇƒÖd zapisu danych klienta ‚ùå");
          }
        });

        // === KLIENT ‚Äì notatki (jak chcesz, mo≈ºe na razie zostaƒá mockiem) ===
        $("btnClientNotesSave")?.addEventListener("click", async () => {
          const payload = {
            clientNotes: $("clientNotes").value.trim(),
          };
          try {
            await saveSection(caseId, "client-notes", payload);
            showSaveToast("Uwagi o kliencie zapisane ‚úÖ");
          } catch (e) {
            console.error(e);
            showSaveToast("B≈ÇƒÖd zapisu uwag o kliencie ‚ùå");
          }
        });

        // === KREDYT ===
        const btnCredit = $("btnCreditSave");
        btnCredit?.addEventListener("click", async () => {
          const payload = {
            loan_amount: $("creditAmount").value
              ? Number($("creditAmount").value)
              : undefined,
            contract_date: $("creditStartDate").value || undefined,
            bank: $("creditBank").value.trim() || undefined,
          };

          try {
            await saveSection(caseId, "credit", payload);
            handleSectionSaved(btnCredit, "Dane kredytu zapisane");
          } catch (e) {
            console.error(e);
            showSaveToast("B≈ÇƒÖd zapisu danych kredytu ‚ùå");
          }
        });

        // === SKD ‚Äì dane podstawowe (NA RAZIE tylko front, bez zapisu p√≥l SKD) ===
        $("btnSkdSave")?.addEventListener("click", () => {
          showSaveToast("Dane SKD zapisane (lokalnie) ‚úÖ");
        });

        // === ETAP SPRAWY ‚Äì tu ROBIMY PRAWDZIWY ZAPIS (pole status) ===
        $("caseStage")?.addEventListener("change", async () => {
          const stageValue = $("caseStage").value;

          // 1) animacja paska
          updateCaseProgress(stageValue);

          // 2) payload zgodny z backendem ‚Äì backend zna tylko "status"
          const payload = { status: stageValue };

          try {
            await saveSection(caseId, "skd", payload);
            showSaveToast("Etap sprawy zapisany ‚úÖ");

            // 3) od≈õwie≈º mini-podsumowanie w sidebarze
            const summaryStage = $("summaryStage");
            if (summaryStage) {
              summaryStage.textContent = stageValue;
            }
          } catch (e) {
            console.error(e);
            showSaveToast("B≈ÇƒÖd zapisu etapu ‚ùå");
          }
        });

        // === SKD ‚Äì oferta ===
        $("btnSkdOfferSave")?.addEventListener("click", async () => {
          const payload = {
            skdOfferText: $("skdOfferText").value.trim(),
          };
          try {
            await saveSection(caseId, "skd-offer", payload);
            showSaveToast("Oferta SKD zapisana ‚úÖ");
          } catch (e) {
            console.error(e);
            showSaveToast("B≈ÇƒÖd zapisu oferty SKD ‚ùå");
          }
        });

        // === NOTATKI SPRAWY ===
        const btnCaseNotes = $("btnCaseNotesSave");
        btnCaseNotes?.addEventListener("click", async () => {
          const payload = {
            notes: $("caseNotes").value.trim() || null,
          };

          try {
            await saveSection(caseId, "notes", payload);
            handleSectionSaved(btnCaseNotes, "Notatki zapisane");
          } catch (e) {
            console.error(e);
            showSaveToast("B≈ÇƒÖd zapisu notatek ‚ùå");
          }
        });

        // === GLOBALNY "ZAPISZ ZMIANY" ===
        $("btnSaveAll")?.addEventListener("click", () => {
          alert(
            "Docelowo tu zrobimy zbiorczy zapis wszystkich sekcji. Na razie u≈ºywaj przycisk√≥w w sekcjach. üôÇ"
          );
        });

        // === POWR√ìT ===
        $("btnBack")?.addEventListener("click", () => {
          window.history.back();
        });
      }

      // === UPLOAD PLIK√ìW DOKUMENT√ìW DO BACKENDU ===
      async function uploadCaseFiles(caseId, files) {
        if (!files || !files.length) return;

        const formData = new FormData();
        files.forEach((f) => formData.append("files", f));

        try {
          const res = await fetch(
            `${API_BASE}/cases/${encodeURIComponent(caseId)}/files`,
            {
              method: "POST",
              body: formData,
            }
          );

          if (!res.ok) {
            const text = await res.text().catch(() => "");
            console.error("B≈ÇƒÖd uploadu plik√≥w:", res.status, text);
            alert("Nie uda≈Ço siƒô dodaƒá plik√≥w ‚ùå");
            return;
          }

          const data = await res.json().catch(() => ({}));
          console.log("üìÅ Pliki dodane do sprawy:", data);
        } catch (err) {
          console.error("B≈ÇƒÖd uploadCaseFiles:", err);
          alert("Nie uda≈Ço siƒô dodaƒá plik√≥w (b≈ÇƒÖd sieci) ‚ùå");
        }
      }

      // === G≈Å√ìWNE ≈ÅADOWANIE SPRAWY ===
      async function loadCaseDetails() {
        const caseId = getCaseIdFromUrl();

        if (!caseId) {
          console.error("Brak parametru id w URL (case.html?id=...)");
          alert("Brak ID sprawy w adresie URL");
          return;
        }

        try {
          console.log("Pobieram dane sprawy", caseId);
          const data = await fetchCaseDetails(caseId);
          console.log("Dane sprawy z API:", data);

          fillCaseHeader(data);
          fillSidebar(data);
          fillClientSection(data);
          fillCreditSection(data);
          fillSkdSection(data);
          fillNotesSection(data);
          await loadCaseFiles(caseId);
          initCaseDocuments(caseId);

          attachSaveHandlers(caseId);
          attachFieldChangeMicroFX();
          attachIbanFormatter();
          attachIbanValidator();
        } catch (e) {
          console.error("B≈ÇƒÖd ≈Çadowania szczeg√≥≈Ç√≥w sprawy:", e);

          // Tymczasowo: bez alertu, bez przekierowania,
          // ≈ºeby zobaczyƒá dok≈Çadny b≈ÇƒÖd w konsoli
          // alert("Sprawa nie istnieje lub nie masz do niej dostƒôpu.");
          // window.location.href = "dashboard.html";
        }
      }

      // === Pobieranie dokument√≥w sprawy ===
      async function loadCaseFiles(caseId) {
        try {
          const res = await fetch(`/api/cases/${caseId}/files`);
          if (!res.ok) {
            console.error("B≈ÇƒÖd pobierania dokument√≥w:", res.status);
            return renderCaseFiles([]);
          }

          const data = await res.json();
          console.log("LOAD_CASE_FILES RESULT =", data);

          const files = Array.isArray(data) ? data : data.files || [];
          renderCaseFiles(files);
        } catch (err) {
          console.error("B≈ÇƒÖd loadCaseFiles:", err);
          renderCaseFiles([]);
        }

        console.log("LOAD_CASE_FILES ‚Üí caseId =", caseId);
        console.log("FETCHING:", `/api/cases/${caseId}/files`);
      }

      // === Renderowanie listy dokument√≥w ===
      function renderCaseFiles(files) {
        const wrapper = document.getElementById("caseFileList");
        if (!wrapper) return;

        wrapper.innerHTML = "";

        if (!files.length) {
          wrapper.innerHTML =
            '<div class="file-list-empty">Brak plik√≥w w tej sprawie</div>';
          return;
        }

        files.forEach((f) => {
          const row = document.createElement("div");
          row.className = "case-file-item case-row";

          row.innerHTML = `
        <div class="case-file-name">
          üìÑ ${f.original_name} (${Math.round(f.size / 1024)} KB)
        </div>
        <div class="case-file-actions">
          <div class="case-file-download" data-id="${f.id}">Pobierz</div>
          <div class="case-file-remove" data-id="${f.id}">‚úï</div>
        </div>
      `;

          wrapper.appendChild(row);
        });
        console.log("RENDER FILES ‚Üí", files);
      }

      // === DRAG & DROP DOKUMENT√ìW (case.html) ===
      function initCaseDocuments(caseId) {
        const $local = (id) => document.getElementById(id);

        const dropArea = $local("caseFileDropArea");
        const fileInput = $local("caseAddFiles");
        const fileList = $local("caseFileList");

        if (!dropArea || !fileInput) {
          console.warn("‚ùó Dokumenty: brak element√≥w dropArea/fileInput");
          return;
        }

        dropArea.addEventListener("click", (e) => {
          if (e.target.closest("a")) {
            return;
          }
          fileInput.click();
        });

        let firstInit = true;

        fileInput.addEventListener("change", async () => {
          if (firstInit) {
            firstInit = false;
            fileInput.value = "";
            return;
          }

          const files = Array.from(fileInput.files || []);
          if (!files.length) return;

          await uploadCaseFiles(caseId, files);
          await loadCaseFiles(caseId);
          fileInput.value = "";
        });

        dropArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropArea.classList.add("dragover");
        });

        dropArea.addEventListener("dragleave", () => {
          dropArea.classList.remove("dragover");
        });

        dropArea.addEventListener("drop", async (e) => {
          e.preventDefault();
          dropArea.classList.remove("dragover");

          const files = Array.from(e.dataTransfer?.files || []);
          if (!files.length) return;

          await uploadCaseFiles(caseId, files);
          await loadCaseFiles(caseId);
        });

        if (fileList) {
          fileList.addEventListener("click", async (e) => {
            const downloadEl = e.target.closest(".case-file-download");
            const removeEl = e.target.closest(".case-file-remove");

            if (downloadEl) {
              const fileId = downloadEl.dataset.id;
              if (!fileId) return;
              window.open(`/api/files/${encodeURIComponent(fileId)}`, "_blank");
              return;
            }

            if (removeEl) {
              const fileId = removeEl.dataset.id;
              if (!fileId) return;

              const ok = confirm("Na pewno usunƒÖƒá ten plik z tej sprawy?");
              if (!ok) return;

              try {
                const res = await fetch(
                  `/api/files/${encodeURIComponent(fileId)}`,
                  { method: "DELETE" }
                );

                if (!res.ok) {
                  const text = await res.text().catch(() => "");
                  console.error("B≈ÇƒÖd usuwania pliku:", res.status, text);
                  alert("Nie uda≈Ço siƒô usunƒÖƒá pliku ‚ùå");
                  return;
                }

                await loadCaseFiles(caseId);
              } catch (err) {
                console.error("B≈ÇƒÖd przy DELETE pliku:", err);
                alert("B≈ÇƒÖd sieci przy usuwaniu pliku ‚ùå");
              }
            }
          });
        }
      }

      // Start
      loadCaseDetails();
    </script>

    <script>
      function getCaseIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const id = params.get("id");
        return id ? Number(id) : null;
      }
      document.addEventListener("DOMContentLoaded", () => {
        const backBtn = document.getElementById("btnBack");
        const saveBtn = document.getElementById("btnSaveAll");
        const deleteBtn = document.getElementById("deleteCaseBtn");

        console.log("[caseWire] init", { backBtn, saveBtn, deleteBtn });

        // ===== POWR√ìT =====
        if (backBtn) {
          backBtn.addEventListener("click", () => {
            console.log("[caseWire] back clicked");
            window.location.href = "/dashboard.html";
          });
        }

        // ===== ZAPISZ ZMIANY =====
        if (saveBtn) {
          saveBtn.addEventListener("click", async () => {
            console.log("[caseWire] save clicked");
            alert(
              "Tu podpinamy zapis danych case (PATCH /api/cases/:id) ‚Äî zrobimy to w nastƒôpnym kroku."
            );
          });
        }

        // ===== USU≈É SPRAWƒò =====
        if (deleteBtn) {
          deleteBtn.addEventListener("click", async () => {
            console.log("[caseWire] delete clicked");

            // 1) ID z URL (?id=40)
            let caseId = getCaseIdFromUrl();
            console.log("[caseWire] ID from URL =", caseId);

            // 2) hidden input (fallback)
            if (!caseId) {
              const hiddenId = document.getElementById("wpsCaseId");
              if (hiddenId && hiddenId.value) {
                const parsed = Number(hiddenId.value);
                if (Number.isFinite(parsed)) caseId = parsed;
              }
            }

            // 3) window.currentCaseId (fallback)
            if (!caseId && window.currentCaseId) {
              const parsed = Number(window.currentCaseId);
              if (Number.isFinite(parsed)) caseId = parsed;
            }

            // 4) ID z pathname (fallback)
            if (!caseId) {
              const matches = window.location.pathname.match(/\d+/g);
              if (matches && matches.length > 0) {
                const last = Number(matches[matches.length - 1]);
                if (Number.isFinite(last)) caseId = last;
              }
            }

            console.log("[caseWire] FINAL caseId =", caseId);

            if (!caseId) {
              alert("Brak ID sprawy ‚Äì nie mogƒô usunƒÖƒá.");
              return;
            }

            if (!confirm("Czy na pewno chcesz usunƒÖƒá tƒô sprawƒô?")) return;
            if (!confirm("Ta operacja jest nieodwracalna. UsunƒÖƒá?")) return;

            const phrase = prompt("Aby potwierdziƒá, wpisz s≈Çowo: USU≈É");
            if (!phrase || phrase.trim().toUpperCase() !== "USU≈É") {
              alert("Nie potwierdzi≈Çe≈õ usuniƒôcia.");
              return;
            }

            try {
              const res = await fetch(`/api/cases/${caseId}`, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
              });

              if (!res.ok) {
                console.error("B≈ÇƒÖd DELETE:", res.status);
                alert("B≈ÇƒÖd podczas usuwania sprawy.");
                return;
              }

              alert("Sprawa zosta≈Ça trwale usuniƒôta.");
              window.location.href = "/dashboard.html";
            } catch (err) {
              console.error("B≈ÇƒÖd DELETE:", err);
              alert("Nie uda≈Ço siƒô usunƒÖƒá sprawy.");
            }
          });
        }
      });
    </script>
    <script>
      (function () {
        // Je≈õli user ma prefers-reduced-motion, nie bawimy siƒô w obserwacje
        var mq =
          window.matchMedia &&
          window.matchMedia("(prefers-reduced-motion: reduce)");
        if (mq && mq.matches) {
          document.querySelectorAll(".case-anim").forEach(function (el) {
            el.classList.add("in-view");
          });
          return;
        }

        var observed = document.querySelectorAll(".case-anim");
        if (!("IntersectionObserver" in window)) {
          // Fallback ‚Äì od razu pokazujemy
          observed.forEach(function (el) {
            el.classList.add("in-view");
          });
          return;
        }

        var observer = new IntersectionObserver(
          function (entries, obs) {
            entries.forEach(function (entry) {
              if (entry.isIntersecting) {
                entry.target.classList.add("in-view");
                // Po pierwszym wej≈õciu nie musimy dalej obserwowaƒá
                obs.unobserve(entry.target);
              }
            });
          },
          {
            threshold: 0.15,
          }
        );

        observed.forEach(function (el) {
          observer.observe(el);
        });

        // Opcjonalnie: ≈Çagodne przewijanie do anchor√≥w w case.html
        document.querySelectorAll("a[href^='#case-']").forEach(function (link) {
          link.addEventListener("click", function (e) {
            var targetId = this.getAttribute("href").slice(1);
            var target = document.getElementById(targetId);
            if (!target) return;
            e.preventDefault();
            target.scrollIntoView({ behavior: "smooth", block: "start" });
          });
        });
      })();
    </script>
  </body>
</html>
